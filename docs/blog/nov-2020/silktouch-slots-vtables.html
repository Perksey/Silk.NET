<!DOCTYPE html>
<html lang="en">


<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  
      <title>
        SilkTouch: Slots &amp; VTables - Silk.NET
      </title>
      <meta property="og:title" content="SilkTouch: Slots &amp; VTables" />
      <meta property="og:site_name" content="Silk.NET - High-Speed &amp; Advanced .NET Graphics &amp; Compute" />

          <meta name="description" content="Please read the previous blog post, which introduces SilkTouch and it&#x27;s core features Invokes &amp;amp; Marshalling." />

      <meta property="og:type" content="article" />

      <meta name="og:image" content="https://dotnet.github.io/Silk.NET/images/logo64.png" />
      <meta name="og:image:alt" content="Silk.NET Logo" />
      <meta name="twitter:card" content="summary" />

  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
  <link href="../../theme/nucleo.css" rel="stylesheet" />
  <link href="../../theme/fontawesome.css" rel="stylesheet" />
  <link href="../../theme/argon.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/nord.min.css">
  <link rel="stylesheet" href="../../theme/silk.css" />
</head>

<body class="silk-dark">
  
  <header class="header-global">
        <nav id="navbar-main" class="navbar navbar-main navbar-expand-lg navbar-horizontal navbar-dark navbar-silk-fixed">
        

<div class="container-fluid">
      <a class="navbar-brand silk-dark-only" href="../..">
        <img src="../../images/wordmarkw.svg">
      </a>
      <a class="navbar-brand silk-light-only" href="../..">
        <img src="../../images/wordmark.svg">
      </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar_global" aria-controls="navbar_global" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="navbar-collapse collapse" id="navbar_global">
    <div class="navbar-collapse-header">
      <div class="row">
        <div class="col-6 collapse-brand">
              <a href="../..">
                <img src="../../images/wordmark.svg">
              </a>
        </div>
        <div class="col-6 collapse-close">
          <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar_global" aria-controls="navbar_global" aria-expanded="false" aria-label="Toggle navigation">
            <span></span>
            <span></span>
          </button>
        </div>
      </div>
    </div>
    <ul class="navbar-nav navbar-nav-hover align-items-lg-center">
              <li class="nav-item dropdown">
                <a href="../../docs" class="nav-link" data-toggle="dropdown" href="#" role="button">
                  <i class="ni ni-bold-right d-lg-none"></i>
                  <span class="nav-link-inner--text">Documentation</span>
                </a>
                <div class="dropdown-menu dropdown-menu-xl">
                  <div class="dropdown-menu-inner">
                            <a href="../../docs/opengl" class="media d-flex align-items-center">
                              <div class="icon icon-shape bg-gradient-primary rounded-circle text-white">
                                <i class="ni ni-spaceship"></i>
                              </div>
                              <div class="media-body ml-3">
                                <h6 class="heading text-primary mb-md-1">Getting Started with Silk.NET &amp; OpenGL</h6>
                                <p class="description d-none d-md-inline-block mb-0">Learn how to use Silk.NET for making basic cross-platform games and applications powered by OpenGL.</p>
                              </div>
                            </a>
                            <a href="../../docs/hlu" class="media d-flex align-items-center">
                              <div class="icon icon-shape bg-gradient-warning rounded-circle text-white">
                                <i class="ni ni-ui-04"></i>
                              </div>
                              <div class="media-body ml-3">
                                <h6 class="heading text-warning mb-md-1">Silk.NET Windowing &amp; Input Superbible</h6>
                                <p class="description d-none d-md-inline-block mb-0">The ultimate guide to using Silk.NET&#x27;s high-level cross-platform utilities.</p>
                              </div>
                            </a>
                            <a href="../../docs/silk.net" class="media d-flex align-items-center">
                              <div class="icon icon-shape bg-gradient-danger rounded-circle text-white">
                                <i class="ni ni-delivery-fast"></i>
                              </div>
                              <div class="media-body ml-3">
                                <h6 class="heading text-danger mb-md-1">Tips &amp; Tricks</h6>
                                <p class="description d-none d-md-inline-block mb-0">Miscellaneous further documentation for getting the most out of your Silk.NET applications.</p>
                              </div>
                            </a>
                  </div>
                </div>
              </li>
              <li class="nav-item">
                <a href="../../docs/silk.net/faq.html" class="nav-link">
                  <i class="ni ni-bold-right d-lg-none"></i>
                  <span class="nav-link-inner--text">FAQ</span>
                </a>
              </li>
              <li class="nav-item">
                <a href=".." class="nav-link">
                  <i class="ni ni-bold-right d-lg-none"></i>
                  <span class="nav-link-inner--text">Blog</span>
                </a>
              </li>
    </ul>
    <ul class="navbar-nav align-items-lg-center ml-lg-auto">
      <li class="nav-item">
        <a class="nav-link nav-link-icon silk-dark-only" id="lighton" href="#" data-toggle="tooltip" title="Toggle Light Mode">
          <i class="fa fa-sun"></i>
          <span class="nav-link-inner--text d-lg-none">Toggle Light Mode</span>
        </a>
        <a class="nav-link nav-link-icon silk-light-only" id="lightoff" href="#" data-toggle="tooltip" title="Toggle Dark Mode">
          <i class="fa fa-moon"></i>
          <span class="nav-link-inner--text d-lg-none">Toggle Dark Mode</span>
        </a>
      </li>
          <li class="nav-item">
            <a class="nav-link nav-link-icon" href="https://discord.gg/DTHHXRt" target="_blank" data-toggle="tooltip" title="Chat to us on Discord">
              <i class="fab fa-discord"></i>
              <span class="nav-link-inner--text d-lg-none">Discord</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link nav-link-icon" href="" target="_blank" data-toggle="tooltip" title="Star us on Github">
              <i class="fab fa-github"></i>
              <span class="nav-link-inner--text d-lg-none">GitHub</span>
            </a>
          </li>
          <li class="nav-item d-none d-lg-block ml-lg-4 silk-nav-btn">

            <a href="../../docs" target="_blank" class="btn btn-outline-primary">
              <span class="nav-link-inner--text">Getting Started</span>
            </a>
          </li>
    </ul>
  </div>
</div> 
        </nav>
  </header>
  <div class="container-fluid">
    <div class="row flex-xl-nowrap">
        <!-- Sidenav -->
                <div class="col-12 col-md-3 col-xl-2 ct-sidebar">
            <nav class="collapse ct-links" id="ct-docs-nav">
                <div class="ct-toc-item active">
                        <a class="ct-toc-link" href="..">
                            Blog
                        </a>
                    <ul class="nav ct-sidenav">
                                <li>
                                    <a href="../jan-2022/silkcommunity.html">
                                        Announcing the Silk.NET Community
                                    </a>
                                </li>
                                <li>
                                    <a href="../dec-2021/structure-chaining.html">
                                        Silk.NET Structure Chaining
                                    </a>
                                </li>
                                <li>
                                    <a href="../nov-2021/xamarin-deprecation.html">
                                        Silk.NET, .NET 6, and the Sunsetting of Xamarin Support
                                    </a>
                                </li>
                                <li>
                                    <a href="../mar-2021/dotnetfoundation.html">
                                        .NET Foundation &amp; The next stage for Silk.NET
                                    </a>
                                </li>
                                <li>
                                    <a href="../feb-2021/buildtools.html">
                                        Generating an entire library: An introduction to BuildTools
                                    </a>
                                </li>
                                <li>
                                    <a href="../jan-2021/silk20.html">
                                        Announcing Silk.NET 2.0: The Largest Update To Date
                                    </a>
                                </li>
                                <li>
                                    <a href="../dec-2020/silk20pre5.html">
                                        Silk.NET 2.0 Preview 5: The Final Preview
                                    </a>
                                </li>
                                <li>
                                    <a href="../dec-2020/silk20pre4.html">
                                        Go live with Silk.NET 2.0 Preview 4
                                    </a>
                                </li>
                                <li class="active ct-sidenav-active">
                                    <a href="silktouch-slots-vtables.html">
                                        SilkTouch: Slots &amp; VTables
                                    </a>
                                </li>
                                <li>
                                    <a href="silktouch-invokes-marshalling.html">
                                        SilkTouch: Invokes &amp; Marshalling
                                    </a>
                                </li>
                                <li>
                                    <a href="silk20pre3.html">
                                        Announcing Silk.NET 2.0 Preview 3
                                    </a>
                                </li>
                    </ul>
                </div>
            </nav>
        </div>

        
        <!-- Content Navigation-->
        <div class="d-none d-xl-block col-xl-2 ct-toc">
            <ul class="section-nav"><li class="toc-entry toc-h1"><a href="#silktouch--slots--amp--vtables">SilkTouch: Slots &amp; VTables</a></li><ul><li class="toc-entry toc-h2"><a href="#vtables">VTables</a></li><li class="toc-entry toc-h2"><a href="#concurrentdictionaryvtable">ConcurrentDictionaryVTable</a></li><li class="toc-entry toc-h2"><a href="#how-silktouch-does-it">How SilkTouch does it</a></li><li class="toc-entry toc-h2"><a href="#making-jit-inline">Making JIT inline</a></li><li class="toc-entry toc-h2"><a href="#aot--ahead-of-time-compilation">AOT (Ahead of Time Compilation)</a></li><li class="toc-entry toc-h2"><a href="#addendum--overrides">Addendum: Overrides</a></li></ul></ul>
        </div>

        <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 silk-content silk-blog" role="main">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="../..">Home</a></li>
                            <li class="breadcrumb-item"><a href="..">Blog</a></li>

                        <li class="breadcrumb-item active" aria-current="page">SilkTouch: Slots &amp; VTables</li>
                        <li class="ml-auto silk-sidebar-activator"><a data-toggle="collapse" href="#ct-docs-nav" role="button" aria-expanded="false" aria-controls="ct-docs-nav"><i class="fa fa-bars"></i></a></li>
                    </ol>
                </nav>

            <!-- Content -->
            


    <div class="alert alert-danger" role="alert">
        This site is a work in progress!
    </div>

<h1 id="silktouch--slots--amp--vtables">SilkTouch: Slots &amp; VTables</h1>
<p>Please read <a href="../silktouch-invokes-marshalling.html">the previous blog post</a>, which introduces SilkTouch and it's core features Invokes &amp; Marshalling.</p>
<p>This time, we are going to talk about this little yet essential part of SilkTouch and Silk.NET as a whole. We ignored this last time for simplicity. <code>(CurrentVTable as GeneratedVTable).Load(721, &quot;glGetDebugMessageLog&quot;)</code>.
The quick break down is this, first, we cast <code>CurrentVTable to GeneratedVTable</code> to allow inlining, because it isn't a virtual call anymore (<code>GeneratedVTable</code> is a private sealed class).
Then, besides the native name, we pass a slot to the <code>Load</code> method.</p>
<h2 id="vtables">VTables</h2>
<p>A VTable is basically a &quot;tiny&quot; abstraction around <code>INativeContext</code> it's defined as:</p>
<pre><code class="language-cs">public interface IVTable : IDisposable
{
    void Initialize(INativeContext ctx, int maxSlots);
    IntPtr Load(int slot, string entryPoint);
    void Purge();
}
</code></pre>
<p>Pretty simple, right?
You may wonder what <code>INativeContext</code> is, if you are unfamiliar with Silk.NET.Core it's designed as</p>
<pre><code class="language-cs">public interface INativeContext : IDisposable
{
    IntPtr GetProcAddress(string proc, int? slot = default);
}
</code></pre>
<p>And is implemented by GLFW / SDL and some default / composite types, and provides platform specific information on loading native symbols. It also powers overrides (see addendum)</p>
<p>Note that <code>INativeContext</code> does not cache anything, it's asked to always call directly down to whatever loading mechanism it wraps. This is where <code>IVTable</code> comes in.</p>
<h2 id="concurrentdictionaryvtable">ConcurrentDictionaryVTable</h2>
<p>The &quot;default&quot; <code>IVTable</code> we used was <code>ConcurrentDictionaryVTable</code>, and while it's still there, we don't use it anymore. We only use the generated VTables from SilkTouch. But it still serves as a good example of the basic functionality here.</p>
<p>So, let's go back to our interface. First of all, we know we have to store the <code>INativeContext</code> somewhere, to later load from, then, we can already know the maximum amount of unique slots we are every going to be queried for, and while it's not necessary, we can put that in as the maximum capacity of our <code>ConcurrentDictionary</code> now, I think it's obvious by now that the key of that dictionary is going to be an <code>int</code> (a slot), and maybe that the value is going to be <code>IntPtr</code> (the address we get back from <code>INativeContext.GetProcAddress</code>).</p>
<p>Next, the <code>Load</code> method, it's pretty simple, we just use the <code>GetOrAdd</code> method on our dictionary to either the the existing address, or load it from the <code>INativeContext</code> and then store it into the dictionary.</p>
<p>Last and also least important, <code>Purge</code>. First of all, <code>Purge</code> does not reset the Initialize params, the <code>INativeContext</code> and the number of slots stays the same! So in this implementation, it's just using <code>Clear()</code>.</p>
<h2 id="how-silktouch-does-it">How SilkTouch does it</h2>
<p>Now SilkTouch knows a lot more about the slots. Basically it's just a compile-time Dictionary. In a nutshell, we generate one field per <code>entrypoint</code> and use the <code>slot</code> to find the appropriate field. <code>Purge</code> is just Zeroing all those fields, and <code>Initialize</code> just stores the <code>_ctx</code>.</p>
<p>This allows the whole lookup to be inlined, which allows maximum performance. Now, at first you'd think this will result in just one huuuuge Load function, lot's of <code>if (slot == x) return _...;</code> now, that was much first approach to, I've then quickly learned that JIT does not care how hard you tell it to aggressively inline and optimize, it refuses to inline.</p>
<h2 id="making-jit-inline">Making JIT inline</h2>
<p>Now, it's pretty simple, it's like a binary search, we just sort all the slots, and generate for that section of slots (at the beginning these are all the slots). We then look whether the section of slots is an odd amount of slots, if it is, we load the lowest removing it from the slot section. As a fallback, we put an unreachable throw helper + <code>return default</code>.</p>
<p>Then, we take the mid slot and split again and we do that over and over and over again, recursively. This may be a bit of a surprise, but that means the JIT is happy to inline the whole thing.Loading, in this case means checking whether the field that was found is <code>IntPtr.Zero</code> and if it is, call <code>_ctx.Load</code> otherwise, just return it.</p>
<h2 id="aot--ahead-of-time-compilation">AOT (Ahead of Time Compilation)</h2>
<p>I've recently added support for AOT into Silk.NET, and with it came the idea to add a feature to SilkTouch, preloading. Basically, what it does, it gets rid of all those branches in the loading, and preloads all addresses when <code>Initialize</code> is called. This means that <code>Load</code> call to the <code>IVTable</code> is as good as it gets. Right now we use the <code>Cdecl</code> calling convention in all cases, but that's not hard coded into SilkTouch, it's configurable per-method, this does mean some overhead. Also, every call we have a GC transition, but again, not much we can do about that. in the middle of the cdecl clutter and the GC entry/exit is our amazing <code>call rax</code> which, to my knowledge is the best we can do right now. (If you know any way to improve this please contact me)</p>
<p>Well yeah and that's kind of it. Thanks again, and if you're interested, I encourage you to look at the source yourself, see <a href="https://github.com/dotnet/Silk.NET/blob/v2.0.0/src/Core/Silk.NET.SilkTouch/VTableGeneration.cs">https://github.com/dotnet/Silk.NET/blob/v2.0.0/src/Core/Silk.NET.SilkTouch/VTableGeneration.cs</a></p>
<hr>
<h2 id="addendum--overrides">Addendum: Overrides</h2>
<p>So overrides are the solution to conditionally changing the <code>INativeContext</code> in some cases.</p>
<p>On some platforms, specifically iOS, it's required to statically link the entire application, so trying to load functions from &quot;glfw3.dll&quot; won't work, since it's linked into the application itself, which can only be circumvented using <code>__Internal</code> which can only be used from P/Invoke.
So we had to go back to using P/Invoke.</p>
<p>We didn't want to rely on P/Invoke marshalling, so all P/Invoke signatures are what you would expect to find in the invoke function pointer, the native types, names, etc.
Now, to override this, but only sometimes, SilkTouch generates an override, which is then put into a function <code>CreateDefaultContext</code>. It just compares a parameter with the condition given in the attribute, and then either creates one of the overrides, and then returns either the override, or the default context.
In the generated override, we just put all the P/Invoke definitions, and then a binary tree similar to the one used in VTables, returning the pointer to the correct P/Invoke definition.</p>
<p>And that's it, it's pretty short, but there's not much to it. Once again, check out the relevant code <a href="https://github.com/dotnet/Silk.NET/blob/v2.0.0/src/Core/Silk.NET.SilkTouch/NativeContextOverrides/PInvokeNativeContextOverride.cs">https://github.com/dotnet/Silk.NET/blob/v2.0.0/src/Core/Silk.NET.SilkTouch/NativeContextOverrides/PInvokeNativeContextOverride.cs</a>
You'll kind of get to see this running if you get the iOS or Android demo (included in preview3) running, which both use the P/Invoke override (the latter due to loading bugs). iOS (and Android) support is still pretty experimental, so not yet full glory :)</p>


    <hr class="silk-last-hr">
    <div>
      <div class="col-md-6">
        <div class="copyright">
            &copy; 2022
                <a href="https://dotnetfoundation.org" target="_blank">.NET Foundation and Contributors</a>
        </div>
      </div>
    </div>

    <div class="container-fluid">
        <p class="silk-disclaimer">
            <small>Khronos&#xAE;, Vulkan&#xAE; are registered trademarks, and OpenXR&#x2122; is a trademark of The Khronos Group Inc. and is registered as a trademark in China, the European Union, Japan and the United Kingdom. OpenCL&#x2122;, OpenGL&#xAE;, and the OpenGL ES&#x2122; logos are registered trademarks or trademarks used under license by Khronos. Microsoft&#xAE; and DirectX&#xAE; are registered trademarks of Microsoft Corporation, used solely for identification. All other product names, trademarks, and/or company names are also used solely for identification and belong to their respective owners. Use of external images, trademarks, and/or resources are not endorsements, and no information in or regarding any of these external resources has been endorsed or approved by Silk.NET or the .NET Foundation.</small>
            <br>
            <br>
            <small>Powered by <a href="https://statiq.dev">Statiq Framework</a></small>
        </p>
    </div>

        </main>
    </div>
</div>

  <script src="../../theme/jquery.min.js" type="text/javascript"></script>
  <script src="../../theme/popper.min.js" type="text/javascript"></script>
  <script src="../../theme/bootstrap.min.js" type="text/javascript"></script>
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js"></script>
  <script src="../../theme/argon.js" type="text/javascript"></script>
  <script src="../../theme/clipboard.min.js"></script>
  <script src="../../theme/headroom.min.js"></script>
  <script src="../../theme/silk.js"></script>
</body>

</html>